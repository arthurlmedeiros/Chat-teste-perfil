<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Teste de Perfil</title>
  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: sans-serif;
      padding: 20px;
    }
    input, button {
      padding: 10px;
      font-size: 1em;
      margin-top: 10px;
    }
    button {
      background-color: #007bff;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    .hidden { display: none; }
    canvas {
      margin-top: 30px;
    }
  </style>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <h2>Teste de Perfil Comportamental üß†</h2>

  <label for="name">Digite seu nome completo para come√ßar:</label><br>
  <input type="text" id="name" placeholder="Seu nome aqui" autocomplete="name"/><br>
  <button onclick="startTest()">Come√ßar</button>

  <div id="chat" class="hidden"></div>
  <canvas id="graficoPerfil" class="hidden" width="300" height="300"></canvas>

  <script>
    let currentQuestion = 0;
    let userAnswers = {};
    let userName = "";

    const questions = [
      "1. Ao iniciar um novo projeto, o que √© mais importante para voc√™?\n\na) Ter uma vis√£o clara do objetivo final e inspirar a equipe.\nb) Garantir que todos estejam se comunicando bem.\nc) Planejar cada etapa cuidadosamente.\nd) Focar nos resultados rapidamente.",
      "2. Como voc√™ prefere trabalhar?\n\na) Com liberdade para ideias.\nb) Em colabora√ß√£o com outros.\nc) Com plano bem definido.\nd) Em ambiente competitivo.",
      "3. O que mais te motiva?\n\na) Criar algo inovador.\nb) Construir relacionamentos fortes.\nc) Ter tudo sob controle.\nd) Atingir metas desafiadoras.",
      "4. Como voc√™ lida com mudan√ßas inesperadas?\n\na) Vejo como oportunidade.\nb) Penso nas pessoas.\nc) Ajusto o plano.\nd) Adapto r√°pido pelo resultado.",
      "5. Qual ambiente de trabalho voc√™ prefere?\n\na) Criativo e aut√¥nomo.\nb) Colaborativo e comunicativo.\nc) Organizado e com regras.\nd) Din√¢mico e competitivo.",
      "6. Ao tomar decis√µes, voc√™ geralmente:\n\na) Confia na intui√ß√£o.\nb) Pensa no impacto nas pessoas.\nc) Analisa dados.\nd) Busca o resultado r√°pido.",
      "7. O que voc√™ valoriza mais em uma equipe?\n\na) Vis√£o e liberdade.\nb) Comunica√ß√£o e apoio.\nc) Organiza√ß√£o e prazos.\nd) Resultados e efici√™ncia.",
      "8. Como voc√™ reage a feedbacks?\n\na) Inspira√ß√£o para ideias.\nb) Escuto para melhorar rela√ß√µes.\nc) Analiso objetivamente.\nd) Foco em melhorar resultados.",
      "9. Qual seu maior foco ao realizar tarefas?\n\na) Impacto futuro.\nb) Conex√£o com o time.\nc) Execu√ß√£o correta.\nd) Efici√™ncia e meta.",
      "10. O que mais te incomoda?\n\na) Rotina e falta de criatividade.\nb) Conflitos interpessoais.\nc) Falta de organiza√ß√£o.\nd) Perda de tempo e metas."
    ];

    function startTest() {
      userName = document.getElementById("name").value.trim();
      if (!userName) {
        alert("Por favor, insira seu nome.");
        return;
      }

      document.querySelector("label[for='name']").style.display = "none";
      document.getElementById("name").style.display = "none";
      document.querySelector("button[onclick='startTest()']").style.display = "none";

      document.getElementById("chat").classList.remove("hidden");
      askQuestion();
    }

    function askQuestion() {
      const chat = document.getElementById("chat");
      if (currentQuestion < questions.length) {
        const question = questions[currentQuestion];
        chat.innerHTML = `
          <p><strong>${question.replace(/\n/g, "<br>")}</strong></p>
          <input id="answer" placeholder="Digite a, b, c ou d" onkeydown="handleEnter(event)" />
          <button onclick="submitAnswer()">Enviar</button>
        `;
      } else {
        chat.innerHTML = `<p>Calculando seu perfil... aguarde um instante.</p>`;
        sendResults();
      }
    }

    function handleEnter(e) {
      if (e.key === "Enter") {
        submitAnswer();
      }
    }

    function submitAnswer() {
      const answerEl = document.getElementById("answer");
      if (!answerEl) return;
      const answer = answerEl.value.trim().toLowerCase();
      if (!["a", "b", "c", "d"].includes(answer)) {
        alert("Por favor, responda com a, b, c ou d.");
        return;
      }
      userAnswers[currentQuestion] = answer;
      currentQuestion++;
      askQuestion();
    }

    function sendResults() {
  fetch("https://primary-kh0f-zuper.up.railway.app/webhook/chat-teste-perfil-production.up.railway.app", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ userName, userAnswers })
  })
  .then(res => res.json())
  .then(data => {
    console.log("Resposta recebida:", data);
    const resposta = data.response || data.output || Object.keys(data)[0] || "Obrigado por participar!";
    
    const chat = document.getElementById("chat");
    chat.innerHTML = `
      <p><strong>Resultado:</strong></p>
      <pre style="white-space: pre-wrap; font-size: 0.95em; color: #ccc;">${resposta}</pre>
      <canvas id="graficoPerfil" width="300" height="300"></canvas>
    `;

    // Extrai percentuais com regex
    const matches = resposta.match(/- (√Åguia|Gato|Lobo|Tubar√£o) \(.\): (\d+)%/g);
    if (!matches) return;

    const labels = [], dataValues = [];
    matches.forEach(item => {
      const [, label, valor] = item.match(/- (√Åguia|Gato|Lobo|Tubar√£o).*: (\d+)%/) || [];
      if (label && valor) {
        labels.push(label);
        dataValues.push(parseInt(valor));
      }
    });

    const canvas = document.getElementById("graficoPerfil");
    const ctx = canvas.getContext('2d');
    new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          data: dataValues,
          backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0']
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' },
          title: { display: true, text: 'Distribui√ß√£o de Perfil Comportamental' }
        }
      }
    });
  })
  .catch((err) => {
    console.error("Erro ao enviar os dados:", err);
    document.getElementById("chat").innerHTML = `<p>Erro ao enviar os dados. Veja o console para mais detalhes.</p>`;
  });
}

        const canvas = document.getElementById("graficoPerfil");
        canvas.classList.remove("hidden");
        const ctx = canvas.getContext('2d');
        new Chart(ctx, {
          type: 'pie',
          data: {
            labels: labels,
            datasets: [{
              data: dataValues,
              backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0']
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'bottom' },
              title: { display: true, text: 'Distribui√ß√£o de Perfil Comportamental' }
            }
          }
        });
      })
      .catch(() => {
        document.getElementById("chat").innerHTML = `<p>Erro ao enviar os dados. Tente novamente.</p>`;
      });
    }
  </script>

</body>
</html>
